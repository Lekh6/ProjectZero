{% extends "layoutm.html" %}

{% block title %}Timeline{% endblock %}

{% block content %}
<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="text-danger mb-0">Timeline Overview</h4>
    <div class="btn-group">
      <a href="/timeline?filter=week" class="btn btn-outline-light {% if period == 'week' %}active{% endif %}">Week</a>
      <a href="/timeline?filter=month" class="btn btn-outline-light {% if period == 'month' %}active{% endif %}">Month</a>
      <a href="/timeline?filter=year" class="btn btn-outline-light {% if period == 'year' %}active{% endif %}">Year</a>
    </div>
  </div>

  <div class="card bg-dark border-0 shadow-sm p-4 mb-4">
    <h6 class="text-danger mb-3">Task Frequency</h6>
    <div style="height:350px; position:relative;">
  <canvas id="timelineChart"></canvas>
</div>

  </div>

  <div class="card bg-dark border-0 shadow-sm p-4">
    <h6 class="text-danger mb-3">Calendar View</h6>
    <div class="table-responsive">
      <table class="table table-dark table-striped table-bordered align-middle text-center">
        <thead>
  <tr>
    <th>Date</th>
    <th>Created</th>
    <th>Completed</th>
  </tr>
</thead>
<tbody>
  {% for d in data_created %}
    {% set done = (data_completed | selectattr('day', 'equalto', d.day) | list) %}
    <tr>
      <td>{{ d.day }}</td>
      <td>{{ d.total }}</td>
      <td>{{ done[0].total if done else 0 }}</td>
    </tr>
  {% else %}
    <tr><td colspan="3" class="text-secondary">No tasks found</td></tr>
  {% endfor %}
</tbody>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const ctx = document.getElementById('timelineChart');
if (ctx) {
  const createdLabels = {{ data_created | map(attribute='day') | list | tojson }};
  const createdValues = {{ data_created | map(attribute='total') | list | tojson }};
  const completedLabels = {{ data_completed | map(attribute='day') | list | tojson }};
  const completedValues = {{ data_completed | map(attribute='total') | list | tojson }};

  const allLabels = Array.from(new Set([...createdLabels, ...completedLabels])).sort();

  const createdData = allLabels.map(l => {
    const idx = createdLabels.indexOf(l);
    return idx >= 0 ? createdValues[idx] : 0;
  });

  const completedData = allLabels.map(l => {
    const idx = completedLabels.indexOf(l);
    return idx >= 0 ? completedValues[idx] : 0;
  });

  new Chart(ctx, {
    type: 'line',
    data: {
      labels: allLabels,
      datasets: [
        {
          label: 'Tasks Created',
          data: createdData,
          borderWidth: 2,
          borderColor: '#e53935',
          tension: 0.3,
          fill: false
        },
        {
          label: 'Tasks Completed',
          data: completedData,
          borderWidth: 2,
          borderColor: '#43a047',
          tension: 0.3,
          fill: false
        }
      ]
    },
    options: {
      animation: false,
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { ticks: { color: '#ccc' }, grid: { color: 'rgba(255,255,255,0.1)' } },
        y: { ticks: { color: '#ccc' }, grid: { color: 'rgba(255,255,255,0.1)' } }
      },
      plugins: {
        legend: { labels: { color: '#eee' } }
      }
    }
  });
}
</script>

{% endblock %}
